<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TransMilenio Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 95vh; width: 100%; }
    header {
      background: #e30613;
      color: white;
      text-align: center;
      padding: 10px 0;
      font-weight: bold;
      font-size: 20px;
    }
  </style>
</head>
<body>
  <header>üöå Simulador TransMilenio - Portal Norte ‚Üí H√©roes</header>
  <div id="map"></div>

  <script>
    // =================== CONFIGURACI√ìN ===================
    const API_URL = "https://i55qr1ngai.execute-api.us-east-1.amazonaws.com/prod/get_positions";
    const API_KEY = "tqTTxzx1ri1M1Thy18E0vVB4xexRBDY8aoovw7i5";

    // Coordenadas fijas para la ruta
    const portalNorte = [4.754577, -74.046];
    const heroes = [4.6486, -74.0643];

    // Inicializar mapa Leaflet
    const map = L.map("map").setView([4.7, -74.05], 12);

    // Capa base (OpenStreetMap)
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: "¬© OpenStreetMap contributors",
    }).addTo(map);

    // Ruta visual
    const velocidadPromedio = 20; // km/h
    const colorRuta = velocidadPromedio > 25 ? "green" : velocidadPromedio > 10 ? "red" : "red";

    const route = L.polyline([portalNorte, heroes], {
    color: colorRuta,
    weight: 8,
    opacity: 0.5
    }).addTo(map);


    // Diccionario de marcadores por bus
    const markers = {};

    // Icono de bus
    const busIcon = L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/416/416597.png", // bus rojo
    iconSize: [42, 42],       // tama√±o del √≠cono
    iconAnchor: [21, 21],     // centro del √≠cono
    popupAnchor: [0, -18]     // posici√≥n del popup
    });

    // =================== FUNCI√ìN PARA ACTUALIZAR MAPA ===================
    async function actualizarMapa() {
      try {
        const response = await fetch(API_URL, {
          headers: { "x-api-key": API_KEY },
        });
        const text = await response.text();
        console.log("API consultada con √©xito.");
        console.log("Respuesta API:", text);

        
        const parsed = JSON.parse(text);
        console.log("Objeto parseado:", parsed);

        const buses = typeof parsed.body === "string" ? JSON.parse(parsed.body) : parsed;

        buses.forEach(bus => {
          const id = bus._id;
          const [lon, lat] = bus.last_position.coordinates;
          const speed = bus.speed ? bus.speed.toFixed(1) : 0;
          const status = bus.status || "DESCONOCIDO";

          // Crear o actualizar marcador
          if (!markers[id]) {
            markers[id] = L.marker([lat, lon], { icon: busIcon }).addTo(map);
          } else {
            markers[id].setLatLng([lat, lon]);
          }

          markers[id].bindPopup(
            `<b>${id}</b><br>Velocidad: ${speed} km/h<br>Estado: ${status}`
          );
        });
      } catch (err) {
        console.error("‚ùå Error al consultar API:", err);
      }
    }

    // =================== INTERVALO DE ACTUALIZACI√ìN ===================
    actualizarMapa(); // primera carga
    //setInterval(actualizarMapa, 8000); // cada 8 segundos
  </script>
</body>
</html>
